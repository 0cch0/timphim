---
import Layout from '../layouts/Layout.astro'
import List from '../components/List.astro'
import { fetchTMDB } from '../tmdb.ts'

const query = Astro.url.searchParams.get('query') || ''
const title = `Tìm kiếm: ${query}`
let list = []

const imdbIdMatch = query.match(/tt\d+/)
if (!imdbIdMatch) {
	const res = await fetchTMDB('/search/multi', { query })
	const data = await res.json()
	list = data.results
} else {
	const res = await fetchTMDB(`/find/${imdbIdMatch[0]}`, { external_source: 'imdb_id' })
	const data = await res.json()
	list = [...data.movie_results, ...data.tv_results]
	if (list.length == 1) {
		return Astro.redirect(`/${list[0].media_type}/${list[0].id}`)
	}
}

list.sort(byDate)

function byDate(a, b) {
	const dateA = new Date(a.release_date || a.first_air_date || null)
	const dateB = new Date(b.release_date || b.first_air_date || null)
	return dateB - dateA
}
---

<Layout title={title}>
	<List title={title} list={list}>
</Layout>
