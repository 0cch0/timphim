---
import Layout from '../layouts/Layout.astro'
import MediaList from '../components/MediaList.astro'
import tmdb from '../tmdb.ts'

const query = Astro.url.searchParams.get('query') || ''
const title = `Tìm kiếm: ${query}`
let list = []

const imdbIdMatch = query.match(/tt\d+/)
if (!imdbIdMatch) {
	const res = await tmdb.get('/search/multi', { query })
	const data = await res.json()
	list = data.results
} else {
	const res = await tmdb.get(`/find/${imdbIdMatch[0]}`, { external_source: 'imdb_id' })
	const data = await res.json()
	list = [...data.movie_results, ...data.tv_results]
	if (list.length == 1) {
		return Astro.redirect(`/${list[0].media_type}/${list[0].id}`)
	}
}
---

<Layout title={title}>
	<b>{title}</b>
	<hr class="hr-dot">
	<MediaList list={list}>
</Layout>
